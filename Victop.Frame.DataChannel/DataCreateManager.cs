//------------------------------------------------------------------------------
// <auto-generated>
//     此代码由工具生成
//     如果重新生成代码，将丢失对此文件所做的更改。
// </auto-generated>
//------------------------------------------------------------------------------
namespace Victop.Frame.DataChannel
{
    using System;
    using System.Collections;
    using System.Collections.Generic;
    using System.Data;
    using System.Linq;
    using System.Text;
    using System.Xml;
    using System.Xml.Linq;
    using Victop.Frame.CoreLibrary.Models;
    using Victop.Frame.PublicLib.Helpers;

    /// <summary>
    /// 数据创建器
    /// </summary>
    /// <remarks>数据创建管理器</remarks>
    public class DataCreateManager
    {
        /// <summary>
        /// 依据应答消息创建DataSet并存储到Hashtable
        /// </summary>
        private Hashtable CreateDataSetByReplyMessage(ReplyMessage replyMessageInfo, RequestMessage messageInfo)
        {
            Hashtable hashData = new Hashtable();
            ChannelData channelData = new ChannelData();
            channelData.MessageInfo = messageInfo;
            Dictionary<string, string> contDic = JsonHelper.ToObject<Dictionary<string, string>>(replyMessageInfo.ReplyContent);
            if (messageInfo.MessageType.Equals("DataChannelService.loadDataByModelAsync"))
            {
                channelData.DataInfo = CreateDataSetByJSON(replyMessageInfo.ReplyContent);
            }
            else
            {
                if (contDic == null)
                {
                    channelData.DataInfo = CreateDataSet(replyMessageInfo.ReplyContent);
                }
                else
                {
                    channelData.DataInfo = CreateDataSet(contDic["Result"]);
                }
            }
            hashData.Add("Data", channelData);
            return hashData;

        }
        /// <summary>
        /// 根据Xml格式文本创建DataSet
        /// </summary>
        /// <param name="dataXml"></param>
        /// <returns></returns>
        private DataSet CreateDataSet(string dataXml)
        {
            DataSet ReplyData = new DataSet();
            if (string.IsNullOrEmpty(dataXml))
            {
                return ReplyData;
            }
            try
            {
                XmlDocument doc = new XmlDocument();
                doc.LoadXml(dataXml);

                XmlNodeList xmlNodeList = doc.DocumentElement.SelectNodes("DATASET");
                foreach (XmlNode node in xmlNodeList)
                {
                    DataTable dt = new DataTable();
                    string datasetId = node.Attributes["datasetid"].Value;
                    XmlNodeList nodexmlNodeList = node.ChildNodes;
                    foreach (XmlNode childNode in nodexmlNodeList)
                    {
                        if (childNode.Name.Equals("DATAPACKET"))
                        {
                            dt = CreateDataSchema(childNode);
                            dt = SetDataTableRow(dt, childNode);
                        }
                    }
                    dt.TableName = datasetId;
                    ReplyData.Tables.Add(dt);
                }
            }
            catch (Exception)
            {

                throw;
            }
            ReplyData.AcceptChanges();
            return ReplyData;
        }
        /// <summary>
        /// 根据JSON格式文本创建DataSet
        /// </summary>
        /// <param name="dataJSON"></param>
        /// <returns></returns>
        private DataSet CreateDataSetByJSON(string dataJSON)
        {
            DataSet ds = new DataSet();
            string resultStr = JsonHelper.ReadJsonString(dataJSON, "Result");
            string metaStr = JsonHelper.ReadJsonString(resultStr, "meta");
            string dataStr = JsonHelper.ReadJsonString(resultStr, "data");
            List<object> metaList = JsonHelper.ToObject<List<object>>(metaStr);
            List<object> dataList = JsonHelper.ToObject<List<object>>(dataStr);
            Dictionary<string, object> metaDic = JsonHelper.ToObject<Dictionary<string, object>>(metaList[0].ToString());
            Dictionary<string, object> dataDic = JsonHelper.ToObject<Dictionary<string, object>>(dataList[0].ToString());
            string datasetsStr = metaDic["datasets"].ToString();
            string datarowsStr = dataDic["datarows"].ToString();
            List<object> datatableList = JsonHelper.ToObject<List<object>>(datasetsStr);
            List<object> datarowsList = JsonHelper.ToObject<List<object>>(datarowsStr);
            for (int i = 0; i < datatableList.Count; i++)
            {
                Dictionary<string, object> tableInfoDic = JsonHelper.ToObject<Dictionary<string, object>>(datatableList[i].ToString());
                string keyField = tableInfoDic["keys"].ToString();
                DataTable dt = new DataTable(tableInfoDic["datasetname"].ToString());
                string fieldStr = tableInfoDic["fields"].ToString();
                List<object> fieldList = JsonHelper.ToObject<List<object>>(fieldStr);
                for (int j = 0; j < fieldList.Count; j++)
                {
                    Dictionary<string, object> fieldInfo = JsonHelper.ToObject<Dictionary<string, object>>(fieldList[j].ToString());
                    DataColumn dc = new DataColumn();
                    dc.ColumnName = fieldInfo["fieldid"].ToString();
                    dc.Caption = fieldInfo["fieldcaption"].ToString();
                    switch (fieldInfo["datatype"].ToString())
                    {
                        case "日期":
                            dc.DataType = typeof(DateTime);
                            break;
                        case "GUID":
                            dc.DataType = typeof(Guid);
                            break;
                        case "整型":
                            dc.DataType = typeof(Int32);
                            break;
                        case "字符":
                        default:
                            dc.DataType = typeof(String);
                            break;
                    }
                    dt.Columns.Add(dc);
                }
                for (int j = 0; j < datarowsList.Count; j++)
                {
                    Dictionary<string, object> datarowInfo = JsonHelper.ToObject<Dictionary<string, object>>(datarowsList[j].ToString());
                    DataRow dr = dt.NewRow();
                    foreach (DataColumn dataCol in dt.Columns)
                    {
                        if (datarowInfo[dataCol.ColumnName] == null)
                            continue;
                        if (dataCol.DataType == typeof(DateTime))
                        {
                            dr[dataCol] = datarowInfo[dataCol.ColumnName].ToString().Replace("T", " ").Substring(0, 19);
                        }
                        else
                        {
                            dr[dataCol] = datarowInfo[dataCol.ColumnName];
                        }
                    }
                    dt.Rows.Add(dr);
                }
                ds.Tables.Add(dt);
            }
            return ds;
        }

        private DataTable SetDataTableRow(DataTable dt, XmlNode xmlNode)
        {
            dt.Clear();
            XmlNodeList nodeList = xmlNode.SelectSingleNode("ROWDATA").SelectNodes("ROW");
            foreach (XmlNode item in nodeList)
            {
                DataRow dr = dt.NewRow();
                foreach (DataColumn dc in dt.Columns)
                {
                    if (item.Attributes[dc.ColumnName] == null)
                        continue;
                    if (dc.DataType == typeof(DateTime))
                    {
                        dr[dc] = item.Attributes[dc.ColumnName].Value.Replace("T", " ").Substring(0, 19);
                    }
                    else
                    {
                        dr[dc] = item.Attributes[dc.ColumnName].Value;
                    }
                }
                dt.Rows.Add(dr);
            }
            return dt;
        }
        /// <summary>
        /// 创建Data模式
        /// </summary>
        /// <param name="xmlNode"></param>
        /// <returns></returns>
        private DataTable CreateDataSchema(XmlNode xmlNode)
        {
            DataTable dt = new DataTable();
            XmlNodeList fieldList = xmlNode.SelectSingleNode("METADATA").SelectSingleNode("FIELDS").SelectNodes("FIELD");
            foreach (XmlNode item in fieldList)
            {
                #region 临时处理SOA返回表结构出现重复列的情况
                if (dt.Columns.Contains(item.Attributes["attrname"].Value))
                    continue;
                #endregion
                dt.Columns.Add(SetDataColumnInfo(item));
            }
            return dt;
        }
        /// <summary>
        /// 创建DataTable中的列
        /// </summary>
        /// <param name="xmlNode"></param>
        /// <returns></returns>
        private DataColumn SetDataColumnInfo(XmlNode xmlNode)
        {
            DataColumn dc = new DataColumn();
            dc.ColumnName = xmlNode.Attributes["attrname"].Value;
            string fieldType = xmlNode.Attributes["fieldtype"].Value;
            switch (fieldType)
            {
                case "i4":
                    dc.DataType = typeof(Int16);
                    break;
                case "i8":
                    dc.DataType = typeof(Int32);
                    break;
                case "dateTime":
                    dc.DataType = typeof(DateTime);
                    dc.DateTimeMode = DataSetDateTime.Utc;
                    break;
                case "string":
                default:
                    dc.DataType = typeof(string);
                    dc.MaxLength = Convert.ToInt32(xmlNode.Attributes["WIDTH"].Value);
                    break;
            }
            return dc;
        }

        /// <summary>
        /// 根据DataSet完善应答消息体
        /// </summary>
        public virtual RequestMessage CreateMessageByDataSet(string channelId)
        {
            throw new System.NotImplementedException(); //TODO:方法实现
        }

        /// <summary>
        /// 获取xml格式数据
        /// </summary>
        public virtual string GetXmlData(string channelId, bool masterFlag = true)
        {
            DataChannelManager dataManager = new DataChannelManager();
            Hashtable hashData = dataManager.GetData(channelId);
            ChannelData channelData = hashData["Data"] as ChannelData;
            DataSet requestDs = channelData.DataInfo;
            StringBuilder stringBuilder = new StringBuilder();
            stringBuilder.Append("<?xml version=\"1.0\"  encoding=\"utf-8\"?>");
            stringBuilder.Append("<DATA>");
            foreach (DataTable mastDt in requestDs.Tables)
            {
                if (masterFlag && !mastDt.TableName.Equals("masterdata"))
                    continue;
                stringBuilder.Append("<DATASET id=\"").Append(mastDt.TableName).Append("\">");
                stringBuilder.Append("<DATAPACKET Version=\"").Append("2.0").Append("\">");
                stringBuilder.Append("<METADATA>");
                stringBuilder.Append("<FIELDS>");
                foreach (DataColumn mastDc in mastDt.Columns)
                {
                    string fieldType = "string";
                    long fieldLength = 50;
                    switch (mastDc.DataType.Name)
                    {
                        case "Int16":
                            fieldType = "i4";
                            fieldLength = 11;
                            break;
                        case "Int32":
                        case "Int64":
                            fieldType = "i8";
                            fieldLength = 20;
                            break;
                        case "DateTime":
                            fieldType = "dateTime";
                            fieldLength = 23;
                            break;
                        case "String":
                            fieldLength = mastDc.MaxLength;
                            break;
                        default:
                            fieldType = "string";
                            break;
                    }
                    stringBuilder.AppendFormat("<FIELD attrname='{0}' fieldtype='{1}' WIDTH='{2}' /> ", mastDc.ColumnName, fieldType, fieldLength);
                }
                stringBuilder.Append("</FIELDS>");
                stringBuilder.Append("</METADATA>");
                stringBuilder.Append("<ROWDATA>");
                foreach (DataRow mastDr in mastDt.Rows)
                {
                    if (mastDr.RowState == DataRowState.Added)
                    {
                        GetDataRowXml(stringBuilder, mastDt, mastDr, "4");
                    }
                    else if (mastDr.RowState == DataRowState.Modified)
                    {
                        GetDataRowXml(stringBuilder, mastDt, mastDr, "8");
                        GetDataRowXml(stringBuilder, mastDt, mastDr, "1", true);
                    }
                    else if (mastDr.RowState == DataRowState.Deleted)
                    {
                        GetDataRowXml(stringBuilder, mastDt, mastDr, "2", true);
                    }
                }
                stringBuilder.Append("</ROWDATA>");
                stringBuilder.Append("</DATAPACKET>");
                stringBuilder.Append("</DATASET>");
            }
            stringBuilder.Append("</DATA>");
            return stringBuilder.ToString();
        }

        private static void GetDataRowXml(StringBuilder stringBuilder, DataTable mastDt, DataRow mastDr, string rowState, bool isDelete = false)
        {
            try
            {
                stringBuilder.Append("<ROW ");
                stringBuilder.AppendFormat("RowState='{0}'", rowState);
                foreach (DataColumn mastDc in mastDt.Columns)
                {
                    if (mastDc.DataType == typeof(DateTime))
                    {
                        string dateTimeStr = string.Empty;
                        if (isDelete)
                        {
                            dateTimeStr = string.IsNullOrEmpty(mastDr[mastDc.ColumnName, DataRowVersion.Original].ToString()) ? "" : ((DateTime)mastDr[mastDc.ColumnName, DataRowVersion.Original]).ToString("yyyy-MM-ddTHH:mm:ss");
                        }
                        else
                        {
                            dateTimeStr = string.IsNullOrEmpty(mastDr[mastDc.ColumnName].ToString()) ? "" : ((DateTime)mastDr[mastDc.ColumnName]).ToString("yyyy-MM-ddTHH:mm:ss");
                        }
                        stringBuilder.AppendFormat(" {0}='{1}' ", mastDc.ColumnName, dateTimeStr);
                    }
                    else
                    {
                        if (isDelete)
                        {
                            stringBuilder.AppendFormat(" {0}='{1}' ", mastDc.ColumnName, mastDr[mastDc.ColumnName, DataRowVersion.Original]);
                        }
                        else
                        {
                            stringBuilder.AppendFormat(" {0}='{1}' ", mastDc.ColumnName, mastDr[mastDc.ColumnName]);
                        }
                    }
                }
                stringBuilder.AppendFormat("/>");
            }
            catch (Exception ex)
            {

            }
        }

        /// <summary>
        /// 提交通道数据
        /// </summary>
        public virtual bool CommitChannelData(string channelId)
        {
            try
            {
                DataChannelManager dataManager = new DataChannelManager();
                Hashtable hashData = dataManager.GetData(channelId);
                ChannelData channelData = hashData["Data"] as ChannelData;
                DataSet requestDs = channelData.DataInfo;
                if (requestDs != null)
                {
                    requestDs.AcceptChanges();
                    return true;
                }
                return false;
            }
            catch (Exception ex)
            {
                return false;
            }
        }

        /// <summary>
        /// 发送应答消息(连接器使用)
        /// </summary>
        public virtual ReplyMessage SendReplyMessage(ReplyMessage replyMessageInfo, RequestMessage messageInfo)
        {
            Hashtable replyHashtable = CreateDataSetByReplyMessage(replyMessageInfo, messageInfo);
            DataChannelManager dataManager = new DataChannelManager();
            if (dataManager.AddData(replyMessageInfo.MessageId, replyHashtable))
            {
                replyMessageInfo.DataChannelId = replyMessageInfo.MessageId;
                replyMessageInfo.ReplyContent = string.Empty;
            }
            return replyMessageInfo;
        }

        /// <summary>
        /// 发送消息(到消息管理器)
        /// </summary>
        public virtual ReplyMessage SendMessage(string messageInfo)
        {
            throw new System.NotImplementedException(); //TODO:方法实现
        }

    }
}

